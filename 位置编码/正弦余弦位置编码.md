## 概述

正弦余弦位置编码是Transformer模型中用于注入序列位置信息的一种方法。由于Transformer的自注意力机制本身不具备感知序列顺序的能力，位置编码通过为每个位置生成独特的嵌入向量，使模型能够区分不同位置的token。该方法通过预定义的三角函数（正弦和余弦）生成位置编码，无需学习参数。

## 数学原理

### 编码公式

对于位置 $pos$（从0开始计数）和维度 $i$（$0 \leq i < d_{\text{model}}/2$），位置编码向量 $PE_{(pos)} \in \mathbb{R}^{d_{\text{model}}}$ 的每个元素定义为：
$$
PE_{(pos, 2i)} = \sin\left( \frac{pos}{10000^{2i/d_{\text{model}}}} \right)
$$
$$
PE_{(pos, 2i+1)} = \cos\left( \frac{pos}{10000^{2i/d_{\text{model}}}} \right)
$$

其中：
- $d_{\text{model}}$ 是模型的嵌入维度（如512）。
- $2i$ 和 $2i+1$ 表示维度索引的奇偶交替。

### 频率项分析

周期计算：
$$T = \frac{2\pi}{\omega} = 2\pi \times 10000^{\frac{2i}{d_{model}}}$$

分母中的 $10000^{2i/d_{\text{model}}}$ 控制不同维度的波长：
- 当 $i$ 较小时，分母较小，频率较高（波长短），相邻位置的编码值变化明显，可以捕捉到局部的关系。
- 当 $i$ 较大时，分母较大，频率较低（波长长），较远的距离也不会出现重复编码，有助于捕捉全局的位置关系。

波长范围从 $2\pi$（$i=0$）到 $2\pi \times 10000$（$i=d_{\text{model}}/2-1$）。

### 相对位置关系的线性性

正弦余弦编码的关键特性是：对于固定偏移量 $k$，存在线性变换矩阵 $M$ 使得：
$$
PE_{pos + k} = M \cdot PE_{pos}
$$
这是因为三角函数满足：
$$
\sin(\omega_i (pos + k)) = \sin(\omega_i pos)\cos(\omega_i k) + \cos(\omega_i pos)\sin(\omega_i k)
$$
$$
\cos(\omega_i (pos + k)) = \cos(\omega_i pos)\cos(\omega_i k) - \sin(\omega_i pos)\sin(\omega_i k)
$$
这使得模型可以通过注意力机制隐式学习相对位置关系。

## 优点和缺点

### 优点

- **无参计算**
	- 无需训练，节省内存和计算资源。
- **外推性**
	- 理论上可处理任意长度序列（但实际中超长序列效果可能下降）。
- **相对位置感知**
	- 通过波长差异和线性性，天然支持相对位置建模。

### 缺点

- **绝对位置敏感度不足**
	- 高频维度在长序列中可能出现重复周期，导致位置混淆。
- **频率分布固定**
	- $10000$ 的基数可能不是所有任务的最优选择。
	- 可以通过一些让模型自动学习频率的方法来避免这个问题。
- **与词嵌入的交互简单**
	- 直接相加可能无法充分融合语义和位置信息，造成信息干扰。
- **长序列衰减**
	- 远距离位置的编码点积值可能趋近于零（通过Softmax后被抑制）

两个位置 $pos$ 和 $pos+k$ 的编码点积：
$$
PE_{pos} \cdot PE_{pos+k} = \sum_{j=0}^{d/2-1} [\sin(\omega_j pos)\sin(\omega_j (pos+k)) + \cos(\omega_j pos)\cos(\omega_j (pos+k))]
$$
利用积化和差化简得到：
$$
= \sum_{j=0}^{d/2-1} \cos(\omega_j k)
$$
当位置差$k$增大时，编码会震荡的趋向0。证明需要一些篇幅，但可以简单想象下当$k$增加到很大时，所有频率的cos图像都会被拉平。